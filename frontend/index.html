<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Option Pricer</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
  background: #f5f7fa;
  margin: 0;
  padding: 2rem;
  color: #222;
}

h1 {
  margin-bottom: 1rem;
  text-align: center;
}

.container {
  background: white;
  padding: 2rem 2.5rem;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  max-width: 900px;
  margin: auto;
}

.row {
  display: flex;
  align-items: center;
  margin-bottom: 0.6rem;
}

label {
  width: 160px;
  font-weight: 600;
  margin-right: 8px;
}

input, select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 140px;
  margin-right: 20px;
}

input[type=range] {
  width: 180px;
  accent-color: #4f46e5;
  margin-right: 8px;
}

input:focus, select:focus {
  outline: none;
  border-color: #4f46e5;
}

.output {
  margin-top: 2rem;
  background: #f9fafb;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.section {
  margin-top: 1rem;
}

.metric {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.4rem;
  font-size: 15px;
}

.greeks {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.4rem 2rem;
}

.metric strong {
  color: #333;
}

canvas {
  margin-top: 1rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  width: 100%;
  max-width: 700px;
  height: 250px;
}
</style>
</head>

<body>

<div class="container">

<h1>Option Pricer</h1>

<form id="optionForm">

<div class="row">
<label>Spot (S)</label><input type="number" step="0.01" name="S" value="100">
<label>Strike (K)</label><input type="number" step="0.01" name="K" value="100">
</div>

<div class="row">
<label>Maturity (T)</label><input type="number" step="0.01" name="T" value="1">
<label>Rate (r)</label><input type="number" step="0.0001" name="r" value="0.05">
</div>

<div class="row">
<label>Volatility σ</label>
<input type="range" min="0.01" max="1" step="0.01" name="sigma" value="0.2">
<span id="volDisplay" style="width:40px; display:inline-block;">0.20</span>
<label>Market Price</label><input type="number" step="0.01" name="market_price">
</div>

<div class="row">
<label>Call / Put</label>
<select name="is_call">
<option value="true">Call</option>
<option value="false">Put</option>
</select>

<label>American</label>
<select name="is_american">
<option value="false">No</option>
<option value="true">Yes</option>
</select>
</div>

</form>

<div class="output" id="output">Adjust inputs to price.</div>

<div class="section">
<h3>Payoff Diagram</h3>
<canvas id="payoffCanvas"></canvas>
</div>

</div>

<script>
const form = document.getElementById('optionForm');
const output = document.getElementById('output');
const volSlider = form.querySelector('[name="sigma"]');
const volDisplay = document.getElementById('volDisplay');
const canvas = document.getElementById('payoffCanvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = canvas.clientWidth;
  canvas.height = 250;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

volSlider.addEventListener('input', () => {
  volDisplay.textContent = Number(volSlider.value).toFixed(2);
  priceOption();
});

function drawPayoff(spot, strike, isCall, bsPrice, delta) {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const margin = 40;
  const width = canvas.width - 2*margin;
  const height = canvas.height - 2*margin;

  // axes
  ctx.strokeStyle = '#333';
  ctx.beginPath();
  ctx.moveTo(margin, margin + height);
  ctx.lineTo(margin+width, margin + height);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(margin, margin);
  ctx.lineTo(margin, margin + height);
  ctx.stroke();

  // payoff data
  const Smin = spot*0.5;
  const Smax = spot*1.5;
  const n = 100;
  let payoffs = [];
  for(let i=0;i<=n;i++){
    const S = Smin + i*(Smax-Smin)/n;
    const payoff = isCall ? Math.max(S - strike,0) : Math.max(strike - S,0);
    payoffs.push(payoff);
  }
  const maxPayoff = Math.max(...payoffs, bsPrice || 0);

  // payoff line
  ctx.strokeStyle = '#4f46e5';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<=n;i++){
    const S = Smin + i*(Smax-Smin)/n;
    const payoff = payoffs[i];
    const x = margin + (S-Smin)/(Smax-Smin)*width;
    const y = margin + height - payoff/maxPayoff*height;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // Black-Scholes reference line
  if(bsPrice){
    ctx.strokeStyle = '#e11d48';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([5,5]);
    const y = margin + height - bsPrice/maxPayoff*height;
    ctx.beginPath();
    ctx.moveTo(margin, y);
    ctx.lineTo(margin+width, y);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Delta marker
  if(delta){
    const x = margin + (spot-Smin)/(Smax-Smin)*width;
    const y = margin + height - delta/maxPayoff*height;
    ctx.fillStyle = '#10b981';
    ctx.beginPath();
    ctx.arc(x,y,5,0,2*Math.PI);
    ctx.fill();
  }
}

async function priceOption() {
  const formData = new FormData(form);
  const data = {};
  formData.forEach((value,key)=>{
    if(key==='is_call'||key==='is_american'){
      data[key] = value==='true';
    }else if(value!==''){
      data[key] = parseFloat(value);
    }
  });

  try{
    const response = await fetch('https://option-pricer-kjbi.onrender.com/price',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const r = await response.json();

    output.innerHTML = `
<h2>Prices</h2>
<div class="metric"><strong>Black–Scholes</strong><span>${r.bs_price.toFixed(4)}</span></div>
<div class="metric"><strong>Monte Carlo</strong><span>${r.mc_price.toFixed(4)}</span></div>
<div class="metric"><strong>Binomial Tree</strong><span>${r.binomial_price.toFixed(4)}</span></div>

<div class="section">
<h3>Greeks</h3>
<div class="greeks">
<div class="metric"><strong>Delta</strong><span>${r.delta.toFixed(4)}</span></div>
<div class="metric"><strong>Gamma</strong><span>${r.gamma.toFixed(4)}</span></div>
<div class="metric"><strong>Vega</strong><span>${r.vega.toFixed(4)}</span></div>
<div class="metric"><strong>Theta</strong><span>${r.theta.toFixed(4)}</span></div>
<div class="metric"><strong>Rho</strong><span>${r.rho.toFixed(4)}</span></div>
</div>
</div>

${r.implied_vol!==null?`<div class="section"><strong>Implied Vol:</strong> ${r.implied_vol.toFixed(4)}</div>`:''}
`;

    drawPayoff(data.S||100, data.K||100, data.is_call!==false, r.bs_price, r.delta);

  }catch(err){
    output.innerHTML=`<p style="color:red">${err}</p>`;
  }
}

form.querySelectorAll('input, select').forEach(el=>{
  el.addEventListener('input', priceOption);
});

priceOption();
</script>

</body>
</html>